{% extends "layout.html" %} {% block content %}

<xml xmlns="https://developers.google.com/blockly/xml" id="workspaceBlocks" style="display: none"></xml>
<script src="https://unpkg.com/blockly/blockly.min.js"></script>

<!-- <script src="../static/scripts/blockly_compressed.js"></script>
<script src="../static/scripts/blocks_compressed.js"></script>
<script src="../static/scripts/javascript_compressed.js"></script>
<script src="../static/scripts/en.js"></script> -->
<script src="../static/scripts/block.js"></script>

<!-- <script src="../static/scripts/music_maker.js"></script>
<script src="../static/scripts/sound_blocks.js"></script> -->
<!-- <script src="scripts/workspace.js"></script>
<script src="scripts/main.js"></script> -->
<nav class="navbar navbar-main navbar-expand-lg px-0 mx-4 shadow-none border-radius-xl" id="navbarBlur" navbar-scroll="true">
    <div class="container-fluid py-1 px-3">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb bg-transparent mb-0 pb-0 pt-1 px-0 me-sm-6 me-5">
                <li class="breadcrumb-item text-sm text-dark" aria-current="page">Pages</li>
                <li class="breadcrumb-item text-sm text-dark active" aria-current="page">Terminal</li>
            </ol>
           <h6 class="font-weight-bolder mb-0"><b>Terminal</b></h6>
        </nav>
    </div>
</nav>

<div class="container-fluid py-4">
    <div class="container-fluid py-4">
        <div class="row">
            <!-- Row 1 -->
            <div class="col-xl-7 col-sm-6 mb-xl-0 mb-4">
                <div class="card">
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="col-8">
                                <div class="numbers">
                                    <p class="text-sm mb-0 text-capitalize font-weight-bold">Map</p>
                                    <h5 class="font-weight-bolder mb-0">
                                        <b></b>
                                        <!-- <span class="text-success text-sm font-weight-bolder">+55%</span> -->
                                    </h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="col-xl-5 col-sm-6 mb-xl-0 mb-4">
                <div class="p-2 p-md-4 mb-4 text-white rounded bg-secondary h-100">
                    <div class="col-md-12 ">
                        <div class=" border-bottom mb-4">
                            <strong class="d-inline-block mb-2 text-white">Command List</strong>
                        </div>
                        <p class="mt-2" id="textArea"></p>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Row 2 -->
        <div class="row mt-4">
            <div class="col-lg-12 mb-lg-0 mb-4">
                <div class="card" style="background-image: url('{{ url_for("static", filename="/img/prog.jpg")}}'); background-repeat: no-repeat;">
                    <div class="card-body p-3">
                        <!-- Row 1 -->
                        <div class="row">
                            <div class="col-lg-8">
                                <div class="d-flex flex-column h-100">
                                    <h5 class="font-weight-bolder" style="color:white"><b>Car Command Flow</b></h5>
                                    <p class="mb-5" style="color:white">Drag and drop to configure Commands.</p>
                                </div>
                            </div>

                            <div class="col-2 text-end">
                                <button type="button" class="btn btn-success " onclick="showCode()">Send Commands</button>
                            </div>
                            <div class="col-2 text-end">
                                <button type="button" onclick="clearCode()" class="btn btn-danger ">Clear Commands</button>
                            </div>
                        </div>

                        <!-- Row 2 -->
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="blockly-editor ">
                                    <div id="blocklyDiv" style="height: 500px; width: 1213px;"></div>
                                    <xml id="toolbox" style="display: none">
                                        <block type="forward"></block>
                                        <block type="stop"></block>
                                        <block type="turn"></block>
                                        <!-- <block type="print"></block> -->
                                        <block type="repeatuntilend"></block>
                                        <block type="controls_if"></block>
                                        <block type="controls_repeat_ext"></block>
                                        <block type="math_number">
                                            <field name="NUM">123</field>
                                        </block>
                                        <block type="text_print"></block>
                                    </xml>
                                    <xml id="startBlocks" style="display: none">
                                    </xml>
                                </div>
                            </div>
                        </div>
                    </div>
                </div> 
            </div>
        </div>
    </div>
</div>
<script>
    var workspace = Blockly.inject('blocklyDiv',
        {
            toolbox: document.getElementById('toolbox'
            ), trashcan: true
        });

    Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);

    function showCode() {
        // Generate code and display it.
        while (directionArr.length > 0) {
            directionArr.pop();
        }
        result = "";

        Blockly.JavaScript.INFINITE_LOOP_TRAP = null;
        Blockly.JavaScript.addReservedWords('code');

        var code = Blockly.JavaScript.workspaceToCode(workspace);

        directionArr.forEach(function (entry) {
            result = result.concat("", entry);
        });
        alert(result);
        result = code.concat("\n", result);
        document.getElementById('textArea').innerText = result;
    }

    function clearCode() {
        document.getElementById('textArea').innerText = "";
    }

    document.getElementById("execute_btn").onclick = function () {
        const ul = document.getElementById('sqnce-list');
        const listItems = ul.getElementsByTagName('li');

        // Loop through the NodeList object.
        for (let i = 0; i <= listItems.length - 1; i++) {
            var http = new XMLHttpRequest();
            var url = 'http://127.0.0.1:5000/car/commands';
            var params = 'direction=webportal&command=' + listItems[i].innerHTML;
            http.open('POST', url, true);

            //Send the proper header information along with the request
            http.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
            http.send(params);
        }
    }
</script>
{% endblock %}